<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Librería Luna Roja | Arte & Encuadernación</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Plus+Jakarta+Sans:wght@300;400;600&display=swap');
        
        :root {
            --luna-roja: #9b1c1c; /* Rojo carmesí profundo */
            --luna-dark: #0f172a; /* Azul noche */
            --luna-gold: #fde68a; /* Dorado suave/luna */
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #020617; 
            color: #f1f5f9;
        }

        h1, h2, .font-luna {
            font-family: 'Playfair Display', serif;
        }

        /* Header con efecto de cristal (Glassmorphism) */
        .glass-header {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(155, 28, 28, 0.3);
        }

        /* Botón estilo Luna Roja */
        .btn-luna {
            background: linear-gradient(135deg, #9b1c1c 0%, #7f1d1d 100%);
            box-shadow: 0 4px 15px rgba(155, 28, 28, 0.4);
            transition: all 0.3s ease;
        }
        .btn-luna:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(155, 28, 28, 0.6);
            filter: brightness(1.2);
        }

        /* Tarjetas de productos */
        .product-card {
            background: #1e293b;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .product-card:hover {
            border-color: var(--luna-roja);
            transform: scale(1.02);
        }

        /* Animación de carga */
        .loader {
            border: 3px solid rgba(155, 28, 28, 0.1);
            border-top: 3px solid var(--luna-roja);
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Scrollbar personalizada */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--luna-roja); }
    </style>
</head>
<body class="antialiased">

    <!-- Header -->
    <header class="glass-header sticky top-0 z-50 p-4">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row items-center gap-6">
            <!-- Logo con Icono de Luna -->
            <div class="flex items-center justify-between w-full md:w-auto">
                <div class="flex items-center space-x-3 group cursor-pointer" onclick="window.location.reload()">
                    <div class="relative">
                        <i class="fas fa-moon text-3xl text-red-600 rotate-[-15deg] group-hover:rotate-0 transition-transform duration-500"></i>
                        <div class="absolute inset-0 bg-red-600 blur-xl opacity-20 group-hover:opacity-40"></div>
                    </div>
                    <h1 class="text-2xl font-bold tracking-tight">
                        Librería <span class="text-red-600">Luna Roja</span>
                    </h1>
                </div>
                
                <button class="md:hidden text-2xl" onclick="toggleCart()">
                    <i class="fas fa-shopping-basket"></i>
                </button>
            </div>

            <!-- Buscador -->
            <div class="flex-grow w-full md:max-w-xl relative">
                <div class="bg-slate-900/50 border border-slate-700 rounded-full flex items-center px-4 py-2 focus-within:border-red-600 transition-colors">
                    <i class="fas fa-search text-slate-500 mr-3"></i>
                    <input type="text" id="search-input" placeholder="Buscar tesoros, papeles, tintas..." 
                           class="bg-transparent w-full outline-none text-sm text-slate-200 placeholder:text-slate-500">
                </div>
            </div>

            <!-- Carrito -->
            <div class="hidden md:block">
                <button onclick="toggleCart()" class="flex items-center space-x-3 group relative px-4 py-2 rounded-full border border-slate-700 hover:border-red-600 transition-all">
                    <div class="relative">
                        <i class="fas fa-shopping-bag text-slate-300 group-hover:text-red-500 transition-colors"></i>
                        <span id="cart-count" class="absolute -top-2 -right-2 bg-red-600 text-white text-[10px] rounded-full px-1.5 font-bold">0</span>
                    </div>
                    <span class="text-sm font-semibold text-slate-300">Mi Pedido</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main -->
    <main class="max-w-6xl mx-auto p-6">
        
        <!-- Hero Simple -->
        <div class="py-10 text-center md:text-left border-b border-slate-800 mb-10">
            <h2 class="text-4xl font-bold mb-2">Inspiración <span class="text-red-600">Bajo la Luna</span></h2>
            <p class="text-slate-400 font-light">Encuadernación artesanal, papelería fina y estampados con alma.</p>
        </div>

        <!-- Estados -->
        <div id="loading-state" class="flex flex-col items-center justify-center py-20">
            <div class="loader rounded-full h-14 w-14 mb-4"></div>
            <p class="text-slate-500 animate-pulse">Consultando los astros (y el stock)...</p>
        </div>

        <div id="error-state" class="hidden bg-slate-900 border border-red-900/50 p-10 rounded-2xl text-center shadow-2xl">
            <i class="fas fa-moon-stars text-red-600 text-5xl mb-4"></i>
            <h2 class="text-2xl font-bold mb-2">Eclipsado por un error</h2>
            <p class="text-slate-400 mb-6">No pudimos conectar con la base de datos de Google Sheets.</p>
            <button onclick="window.location.reload()" class="btn-luna text-white px-8 py-3 rounded-full font-bold">Intentar de nuevo</button>
        </div>

        <!-- Grid -->
        <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
            <!-- Productos -->
        </div>
    </main>

    <!-- Sidebar Carrito -->
    <div id="cart-overlay" class="fixed inset-0 bg-black/80 z-[60] hidden transition-opacity opacity-0" onclick="toggleCart()"></div>
    
    <aside id="cart-sidebar" class="fixed right-0 top-0 h-full w-full max-w-md bg-slate-900 z-[70] shadow-[-10px_0_30px_rgba(0,0,0,0.5)] flex flex-col translate-x-full transition-transform duration-500 border-l border-red-900/20">
        <div class="p-6 border-b border-slate-800 flex justify-between items-center bg-slate-900">
            <h2 class="text-2xl font-bold flex items-center">
                <i class="fas fa-moon mr-3 text-red-600"></i> Mi Pedido
            </h2>
            <button onclick="toggleCart()" class="text-4xl text-slate-500 hover:text-red-600 transition">&times;</button>
        </div>

        <div id="cart-content" class="flex-grow overflow-y-auto p-6 space-y-6">
            <!-- Items -->
        </div>

        <div class="p-8 border-t border-slate-800 bg-slate-950">
            <div class="flex justify-between text-2xl font-bold mb-8">
                <span class="text-slate-400 text-lg">Total</span>
                <span id="cart-total" class="text-red-600 font-luna">$ 0,00</span>
            </div>
            
            <button onclick="sendToWhatsApp()" class="btn-luna w-full text-white py-4 rounded-xl font-bold text-lg flex items-center justify-center space-x-3 active:scale-[0.98]">
                <i class="fab fa-whatsapp text-2xl"></i>
                <span>Enviar por WhatsApp</span>
            </button>
            <div class="mt-6 flex flex-col items-center space-y-2 opacity-40">
                <p class="text-[10px] uppercase tracking-[0.2em] font-bold">Librería Luna Roja</p>
                <div class="h-[1px] w-12 bg-red-600"></div>
            </div>
        </div>
    </aside>

    <script>
        const WHATSAPP_PHONE = "5491100000000"; 
        const SHEET_ID = "11s7m68TJhweA-lNP0QSVSfXDV8wRBNHbRT0ubremuuM";
        const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv`;

        let products = [];
        let cart = JSON.parse(localStorage.getItem('luna_roja_cart')) || [];

        document.addEventListener('DOMContentLoaded', () => {
            loadStock();
            updateUI();
            document.getElementById('search-input').addEventListener('input', handleSearch);
        });

        async function loadStock() {
            try {
                const response = await fetch(CSV_URL);
                if (!response.ok) throw new Error("Error CSV");
                const data = await response.text();
                const rows = data.split('\n').slice(1);
                
                products = rows.map(row => {
                    const parts = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    const clean = (str) => str ? str.replace(/^"|"$/g, '').trim() : "";
                    return {
                        id: clean(parts[0]),
                        nombre: clean(parts[1]),
                        categoria: clean(parts[2]),
                        precio: parseFloat(clean(parts[3])) || 0,
                        imagen: clean(parts[4]),
                        stock: parseInt(clean(parts[5])) || 0
                    };
                }).filter(p => p.nombre !== "");

                displayProducts(products);
                document.getElementById('loading-state').classList.add('hidden');
            } catch (err) {
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('error-state').classList.remove('hidden');
            }
        }

        function displayProducts(items) {
            const grid = document.getElementById('products-grid');
            grid.innerHTML = "";

            if (items.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center py-20 text-slate-500 font-light text-xl">Ningún objeto encontrado bajo esta luz.</div>`;
                return;
            }

            items.forEach(p => {
                const isOutOfStock = p.stock <= 0;
                grid.innerHTML += `
                    <div class="product-card group rounded-3xl flex flex-col overflow-hidden relative">
                        <div class="h-60 bg-slate-800/50 flex items-center justify-center p-6 relative overflow-hidden">
                            <img src="${p.imagen || 'https://via.placeholder.com/400/1e293b/ef4444?text=Luna+Roja'}" 
                                 class="object-contain h-full w-full transition-transform duration-700 group-hover:scale-110 ${isOutOfStock ? 'opacity-20 grayscale' : ''}"
                                 onerror="this.src='https://via.placeholder.com/400/1e293b/ef4444?text=Imagen+No+Disponible'">
                            
                            ${isOutOfStock ? 
                                '<div class="absolute inset-0 flex items-center justify-center"><span class="bg-black/80 text-white px-4 py-2 rounded-full text-xs font-bold border border-red-900 tracking-widest">AGOTADO</span></div>' 
                                : ''}
                            
                            <div class="absolute top-4 left-4">
                                <span class="bg-slate-900/80 backdrop-blur text-[10px] text-red-500 font-bold px-3 py-1 rounded-full border border-red-900/30 uppercase tracking-tighter">
                                    ${p.categoria}
                                </span>
                            </div>
                        </div>
                        
                        <div class="p-6 flex flex-col flex-grow bg-slate-900/40">
                            <h3 class="text-base font-semibold text-slate-200 mb-2 h-12 overflow-hidden leading-snug group-hover:text-red-500 transition-colors">
                                ${p.nombre}
                            </h3>
                            
                            <div class="mt-auto pt-4 flex items-center justify-between">
                                <span class="text-2xl font-bold text-slate-100">$ ${p.precio.toLocaleString('es-AR')}</span>
                                <button 
                                    onclick="addToCart('${p.id}')"
                                    ${isOutOfStock ? 'disabled' : ''}
                                    class="w-12 h-12 flex items-center justify-center rounded-2xl ${isOutOfStock ? 'bg-slate-800 text-slate-600' : 'btn-luna text-white'} transition-all active:scale-90">
                                    <i class="fas ${isOutOfStock ? 'fa-moon' : 'fa-plus'}"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function addToCart(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;
            const existing = cart.find(item => item.id === id);
            if (existing) { existing.quantity++; } else { cart.push({ ...product, quantity: 1 }); }
            saveAndSync();
            
            // Efecto visual rápido
            const btn = event.currentTarget;
            btn.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => { btn.innerHTML = '<i class="fas fa-plus"></i>'; }, 1000);
        }

        function saveAndSync() {
            localStorage.setItem('luna_roja_cart', JSON.stringify(cart));
            updateUI();
        }

        function updateUI() {
            const content = document.getElementById('cart-content');
            const totalDisplay = document.getElementById('cart-total');
            const countLabel = document.getElementById('cart-count');
            
            const totalQty = cart.reduce((acc, i) => acc + i.quantity, 0);
            countLabel.innerText = totalQty;

            if (cart.length === 0) {
                content.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-80 text-slate-600">
                        <i class="fas fa-moon text-6xl mb-6 opacity-20"></i>
                        <p class="text-lg font-light italic">Tu pedido está a oscuras...</p>
                    </div>`;
                totalDisplay.innerText = "$ 0,00";
                return;
            }

            let total = 0;
            content.innerHTML = cart.map(item => {
                const sub = item.precio * item.quantity;
                total += sub;
                return `
                    <div class="flex items-center space-x-4 bg-slate-800/40 p-4 rounded-2xl border border-slate-700/50">
                        <img src="${item.imagen}" class="w-16 h-16 object-cover rounded-xl bg-slate-700">
                        <div class="flex-grow">
                            <h4 class="text-sm font-semibold text-slate-200 leading-tight">${item.nombre}</h4>
                            <div class="flex items-center mt-1 text-xs text-slate-400">
                                <span>${item.quantity} x $ ${item.precio.toLocaleString('es-AR')}</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-bold text-red-500 mb-2">$ ${sub.toLocaleString('es-AR')}</p>
                            <button onclick="removeFromCart('${item.id}')" class="text-slate-500 hover:text-red-600 transition">
                                <i class="fas fa-trash-alt text-xs"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            totalDisplay.innerText = `$ ${total.toLocaleString('es-AR')}`;
        }

        function removeFromCart(id) {
            cart = cart.filter(item => item.id !== id);
            saveAndSync();
        }

        function toggleCart() {
            const sidebar = document.getElementById('cart-sidebar');
            const overlay = document.getElementById('cart-overlay');
            const isOpen = !sidebar.classList.contains('translate-x-full');
            
            if (!isOpen) {
                sidebar.classList.remove('translate-x-full');
                overlay.classList.remove('hidden');
                setTimeout(() => overlay.classList.add('opacity-100'), 10);
                document.body.style.overflow = 'hidden';
            } else {
                sidebar.classList.add('translate-x-full');
                overlay.classList.remove('opacity-100');
                setTimeout(() => overlay.classList.add('hidden'), 500);
                document.body.style.overflow = 'auto';
            }
        }

        function sendToWhatsApp() {
            if (cart.length === 0) return;
            let total = 0;
            let message = "*LIBRERÍA LUNA ROJA - NUEVO PEDIDO*%0A%0A";
            cart.forEach((item, index) => {
                const sub = item.precio * item.quantity;
                total += sub;
                message += `*${index + 1}. ${item.nombre}*%0A   _Cantidad: ${item.quantity} x $${item.precio.toLocaleString('es-AR')}_%0A   Subtotal: *$${sub.toLocaleString('es-AR')}*%0A%0A`;
            });
            message += `---------------------------%0A*TOTAL DEL PEDIDO: $${total.toLocaleString('es-AR')}*%0A---------------------------%0A%0A_Hola, vi estos productos bajo la luz de la Luna Roja y me gustaría comprarlos._`;
            window.open(`https://wa.me/${WHATSAPP_PHONE}?text=${message}`, '_blank');
        }

        function handleSearch(e) {
            const term = e.target.value.toLowerCase();
            const filtered = products.filter(p => 
                p.nombre.toLowerCase().includes(term) || 
                p.categoria.toLowerCase().includes(term)
            );
            displayProducts(filtered);
        }
    </script>
</body>
</html>